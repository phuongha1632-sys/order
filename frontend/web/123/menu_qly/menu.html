<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />

    <title>Menu</title>
  </head>

  <body>
    <div id="s1">
      <div id="place-sidebar"></div>

      <div id="header">
        <h1>MENU</h1>
      </div>

      <!-- chèn sidebar -->
      <script>
        const sourcefile = "../sidebar.html";
        const placeid = "place-sidebar";

        fetch(sourcefile)
          .then((response) => response.text())
          .then((data) => {
            document.getElementById(placeid).innerHTML = data;

            const button_sidebar = document.getElementById("menu_button");
            const content = document.getElementById("container");
            const backdrop = document.getElementById("sidebar_backdrop");
            const close = document.querySelector(".sidebar-close");

            // mở/đóng sidebar và backdrop
            function openSidebar() {
              content.classList.add("open");
              backdrop.style.display = "block"; //mở lớp phủ
              // ngăn scroll trang chính
              document.body.style.overflow = "hidden";
            }
            function closeSidebar() {
              content.classList.remove("open");
              backdrop.style.display = "none";
              document.body.style.overflow = "";
            }

            close.addEventListener("click", closeSidebar);
            // click vào backdrop => đóng sidebar
            backdrop.addEventListener("click", closeSidebar);

            button_sidebar.addEventListener("click", openSidebar);
          });
      </script>

      <!-- phần nội dung bảng chính hiển thị menu -->
      <!-- nút thêm món -->
      <div id="create_food" style="background-color: rgb(211, 206, 206)">
        <a href="#" style="color: white">Thêm món</a>
      </div>

      <!-- bảng chính -->
      <div class="table-container">
        <table class="table-content">
          <thead>
            <tr>
              <th>ID</th>
              <th>TÊN MÓN</th>
              <th>GIÁ</th>
              <th>TÌNH TRẠNG</th>
              <th>HÌNH ẢNH</th>
              <th>HÀNH ĐỘNG</th>
            </tr>
          </thead>

          <tbody id="main_table_body"></tbody>
        </table>
      </div>

      <!-- hiển thị menu -->
      <script>
        const mainTableBody1 = document.getElementById("main_table_body");

        // gửi request lấy menu về backend
        fetch("http://localhost:3000/api/admin/menu/")
          .then((response) => response.json()) // chuyển response về JS object để frontend đọc
          .then((result) => {
            // Xóa bảng cũ
            mainTableBody1.innerHTML = "";

            // Duyệt từng món ăn
            result.data.forEach((item, index) => {
              const row = document.createElement("tr");
              // GÁN DATASET ( cho chức năng Sửa/Xóa)
              row.dataset.foodId = item.id;
              row.dataset.name = item.name;
              row.dataset.price = item.price;
              row.dataset.status = item.status;
              const encodedImage = encodeURIComponent(item.image);
              row.dataset.image = encodedImage; // Gán giá trị đã mã hóa

              row.innerHTML = `<td>${index + 1}</td> 
                <td>${item.name}</td>
                <td>${item.price}</td>
                <td>${item.status}</td>
                <td>${decodeURIComponent(encodedImage)}</td>
                <td><button class="edit">Sửa</button>
                <button class="del">Xóa</button></td>`;

              mainTableBody1.appendChild(row);
            });
          });
      </script>

      <!------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------>
      <!-- chèn modal -->
      <script>
        const sourcefile_modal = "modal.html";
        const createButton = document.getElementById("create_food");
        const mainTableBody = document.getElementById("main_table_body");
        let modalElement,
          okButton,
          closeButton,
          tenid,
          giaid,
          hinhid,
          tinhtrangid,
          modalTitle;
        let pageElements = []; // Tải HTML của file(trừ modal)
        let currentFoodId = null;

        fetch(sourcefile_modal)
          .then((res) => res.text())
          .then((html) => {
            // 1. CHÈN MODAL VÀO DOM
            const tmp = document.createElement("div");
            tmp.innerHTML =
              html; /*gán trung gian qua tmp tránh phá vỡ css modal*/
            modalElement = tmp.querySelector("#modal");
            modalElement.classList.add("overlay");
            document.body.appendChild(modalElement); //đảm bảo z-index cao nhất, phủ các tphan khác

            // 2. LẤY THAM CHIẾU
            okButton = modalElement.querySelector("#confirm");
            closeButton = modalElement.querySelector(".close_button");
            tenid = modalElement.querySelector("#ten_input");
            giaid = modalElement.querySelector("#gia_input");
            hinhid = modalElement.querySelector("#hinh_input");
            tinhtrangid = modalElement.querySelector("#tinhtrang_input");
            modalTitle = modalElement.querySelector("h1");

            // Tham chiếu các phần tử trên trang chính cần disable/enable
            pageElements = Array.from(document.body.children).filter(
              (child) => child !== modalElement
            );

            // 3. ĐỊNH NGHĨA HÀM DÙNG CHUNG (Open/Close Modal)
            function openModal() {
              modalElement.classList.add("open");
              document.body.style.overflow = "hidden";
              pageElements.forEach((child) =>
                child.classList.add("page-disabled")
              );
            }

            function hideModal() {
              modalElement.classList.remove("open");
              document.body.style.overflow = "";
              pageElements.forEach((child) =>
                child.classList.remove("page-disabled")
              );
              // Reset input sau khi đóng
              tenid.value = "";
              giaid.value = "";
              hinhid.value = "";
              tinhtrangid.value = "";
            }

            // Gán sự kiện đóng modal
            closeButton.addEventListener("click", hideModal);

            //nút confirm trong modal
            okButton.addEventListener("click", function (e) {
              e.preventDefault();
              const ten = tenid.value.trim();
              const gia = giaid.value.trim();
              const tinhtrang = tinhtrangid.value;
              const hinh = hinhid.value.trim();

              if (ten === "" || gia === "") {
                alert("Vui lòng điền đủ Tên và Giá.");
                return;
              }

              // Simple: ảnh cuối cùng
              const finalImage = hinh;

              const payload = {
                name: ten,
                price: gia,
                image: finalImage,
                status: tinhtrang,
              };

              if (currentFoodId) {
                // SỬA (PUT)
                fetch(`http://localhost:3000/api/admin/menu/${currentFoodId}`, {
                  method: "PUT",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(payload),
                })
                  .then((res) => res.json())
                  .then((data) => {
                    if (data.status == "success") {
                      alert("Cập nhật món thành công!");
                      hideModal();
                      location.reload();
                    } else {
                      alert(data.message || "Lỗi khi cập nhật món.");
                    }
                  })
                  .catch((err) => {
                    console.error("Lỗi khi gửi dữ liệu:", err);
                    alert("Lỗi kết nối hoặc xử lý dữ liệu.");
                  });
              } else {
                // THÊM (POST)
                fetch("http://localhost:3000/api/admin/menu/", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify(payload),
                })
                  .then((res) => res.json())
                  .then((data) => {
                    if (data.status == "success") {
                      alert("Thêm món thành công!");
                      hideModal();
                      location.reload();
                    } else {
                      alert(data.message || "Lỗi khi thêm món.");
                    }
                  })
                  .catch((err) => {
                    console.error("Lỗi khi gửi dữ liệu:", err);
                    alert("Lỗi kết nối hoặc xử lý dữ liệu.");
                  });
              }
            });

            // XỬ LÝ THÊM MÓN ở giao diện(ADD)
            createButton.addEventListener("click", function (e) {
              e.preventDefault();
              currentFoodId = null;
              modalTitle.textContent = "Thêm Món Mới";
              okButton.textContent = "Thêm Món";
              openModal();
            });

            // XỬ LÝ SỬA MÓN (EDIT)
            mainTableBody.addEventListener("click", function (e) {
              if (e.target.classList.contains("edit")) {
                const row = e.target.closest("tr");

                currentFoodId = row.dataset.foodId;
                const ten = row.dataset.name;
                const gia = row.dataset.price;
                const tinhtrang = row.dataset.status;
                const encodedImage = row.dataset.image || "";
                const hinh = encodedImage
                  ? decodeURIComponent(encodedImage)
                  : "";

                modalTitle.textContent = "Cập Nhật Món Ăn";
                okButton.textContent = "Cập Nhật";

                // hiển thị tt lại trên input
                tenid.value = ten;
                giaid.value = gia;
                hinhid.value = hinh;
                tinhtrangid.value = tinhtrang;

                openModal();
              }
            });

            // XỬ LÝ XÓA MÓN (DELETE)
            mainTableBody.addEventListener("click", function (e) {
              if (e.target.classList.contains("del")) {
                const row = e.target.closest("tr");

                const foodIdToDelete = row.dataset.foodId;
                const foodName = row.dataset.name;

                if (!foodIdToDelete) {
                  alert("Không tìm thấy ID món ăn để xóa.");
                  return;
                }
                
                if (confirm(`Bạn có chắc chắn muốn xóa món: ${foodName}?`)) {
                  const apiUrl = `http://localhost:3000/api/admin/menu/${foodIdToDelete}`;
                  
                  fetch(apiUrl, { method: "DELETE" })
                    .then((res) => res.json())
                    .then((data) => {
                      if (data.status == "success") {
                        alert(`Đã xóa món ${foodName} thành công.`);
                        location.reload();
                      } else {
                        alert(`Lỗi khi xóa món ${foodName}.`);
                      }
                    })

                    .catch((err) => {
                      console.error("Lỗi khi gửi yêu cầu xóa:", err);

                      alert("Lỗi kết nối hoặc xử lý dữ liệu khi xóa.");
                    });
                }
              }
            });
          });
      </script>
    </div>
  </body>
</html>
