<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Doanh Thu</title>
    <link
      href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div id="s1">
      <div id="header">
        <h1>Doanh thu</h1>
        <div id="place-sidebar"><!--vtri nut sidebar --></div>
      </div>

      <div id="frame1">
        <div id="chart">
          <canvas id="revenueChart"></canvas>
        </div>
        <div id="summary"></div>
      </div>

      <div id="frame2">
        <div id="frame_filter">
          <div class="filter-group">
            <label for="month">Tháng</label>
            <select id="month">
              <option value="" disabled selected hidden>
                -- Chọn tháng --
              </option>
              <option value="1">Tháng 1</option>
              <option value="2">Tháng 2</option>
              <option value="3">Tháng 3</option>
              <option value="4">Tháng 4</option>
              <option value="5">Tháng 5</option>
              <option value="6">Tháng 6</option>
              <option value="7">Tháng 7</option>
              <option value="8">Tháng 8</option>
              <option value="9">Tháng 9</option>
              <option value="10">Tháng 10</option>
              <option value="11">Tháng 11</option>
              <option value="12">Tháng 12</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label for="year">Năm</label>
            <select id="year">
              <option value="" disabled selected hidden>-- Chọn năm --</option>
              <option value="2023">Năm 2023</option>
              <option value="2024">Năm 2024</option>
              <option value="2025">Năm 2025</option>
              <option value="2026">Năm 2026</option>
              <option value="2027">Năm 2027</option>
              <option value="2028">Năm 2028</option>
            </select>
          </div>
          
          <div class="filter-group">
            <button id="confirm">Xác nhận</button>
          </div>
        </div>
        
        <table id="table">
          <thead>
            <tr>
              <th>NGÀY</th>
              <th>TỔNG TIỀN</th>
            </tr>
          </thead>
          <tbody id="table_body"></tbody>
        </table>
      </div>

      <!--Chen tt vao bang chi tiet-->
      <script>
        const mainTableBody = document.getElementById("table_body");
        async function loaddata(month, year) {
          try {
            const res = await fetch(
              `http://localhost:3000/api/admin/report/revenue?month=${month}&year=${year}`
            );
            const resData = await res.json();
            mainTableBody.innerHTML = "";
            const data = resData.data;

            if (data.length > 0) {
              data.forEach((item) => {
                const row = document.createElement("tr");
                row.innerHTML = `<td>${String(item.day).padStart(
                  2,
                  "0"
                )}/${String(month).padStart(2, "0")}/${year}</td>

                  <td>${new Intl.NumberFormat("vi-VN").format(
                    item.total
                  )} đ</td>                `;

                mainTableBody.appendChild(row);
              });
            } else {
              // Xử lý trường hợp không có dữ liệu
              mainTableBody.innerHTML =
                '<tr><td colspan="4">Không tìm thấy đơn hàng nào trong tháng.</td></tr>';
            }
          } catch (err) {
            console.error("Lỗi khi gửi yêu cầu lấy dữ liệu đơn hàng:", err);
            alert(
              "Lỗi kết nối hoặc xử lý dữ liệu khi hiển thị danh sách đơn hàng."
            );
          }
        }
      </script>
      
      <!--tải biểu đồ-->
      <script>
        // 1. Khởi tạo biểu đồ trống trước
        const ctx = document.getElementById("revenueChart").getContext("2d");

        let myChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: [], //cột x
            datasets: [
              {
                label: "",
                data: [], // cột y
                borderColor: "#cb3232",
                backgroundColor: "rgba(203, 50, 50, 0.1)",
                tension: 0.2,
                fill: true,
              },
            ],
          },
        });

        // 2. Hàm fetch dữ liệu từ BE
       async function loadChartData(month, year) {
          try {
            // 1. Chờ lấy dữ liệu từ API
            const res = await fetch(
              `http://localhost:3000/api/admin/report/revenue?month=${month}&year=${year}`
            );
            const resData = await res.json();
            const data = resData.data;

            // 2. Tính toán số ngày trong tháng để vẽ trục X
            const daysInMonth = new Date(year, month, 0).getDate();

            const labels = [];
            const values = [];

            // 3. Vòng lặp để "lấp đầy" đủ 30 hoặc 31 ngày trên biểu đồ
            for (let d = 1; d <= daysInMonth; d++) {
              labels.push(d); // Thêm ngày vào trục X

              // Tìm xem trong dữ liệu từ DB có ngày 'd' này không
              const found = data.find((item) => item.day === d);

              // Nếu có thì lấy tiền (total), không có thì để là 0
              values.push(found ? found.total : 0);
            }

            // 4. Cập nhật dữ liệu mới vào đối tượng biểu đồ (myChart)
            myChart.data.labels = labels;
            myChart.data.datasets[0].data = values;

            // 5. Lệnh quan trọng nhất: Vẽ lại biểu đồ lên màn hình
            myChart.update();
          } catch (err) {
            console.error("Lỗi tải biểu đồ:", err);
          }
        }
      </script>

      <!--Tải tt tổng quát của tháng-->
      <script>
        const right = document.getElementById("summary");
        async function loadsummary(month, year) {
          try {
            // Gọi cả 2 API cùng lúc
            const [resBest, resTotal] = await Promise.all([
              fetch(
                `http://localhost:3000/api/admin/report/best-seller?month=${month}&year=${year}`
              ),
              fetch(
                `http://localhost:3000/api/admin/report/revenue/month?month=${month}&year=${year}`
              ), //đủ cả 2 phản hồi api, mới chạy tiếp xuống dòng dưới
            ]);

            const dataBest = await resBest.json();
            const dataTotal = await resTotal.json();

            // Lấy giá trị an toàn (nếu null thì hiện N/A hoặc 0)
            const bestSellerName = dataBest.data ? dataBest.data : "Chưa có";
            const totalMoney = dataTotal.data ? dataTotal.data.monthTotal : 0;
            const formattedTotal = new Intl.NumberFormat("vi-VN").format(
              totalMoney
            );
            // Ghi vào HTML một lần duy nhất
            right.innerHTML = `
<p>
    <i class='bx bx-happy-heart-eyes' style='color: red;   font-size: 40px;
'></i> 
    Món bán chạy nhất: <strong>${bestSellerName}</strong>
  </p>      <p><i class="bx bx-dollar" style='color: #2ecc71;   font-size: 40px;
'></i> Tổng doanh thu tháng: <strong>${formattedTotal} đ</strong></p>
    `;
          } catch (err) {
            console.error("Lỗi tải summary:", err);
            right.innerHTML = "<p>Không thể tải thông tin tổng quan.</p>";
          }
        }
      </script>
      
      <!--CHỌN TGIAN ĐỂ HIỂN THỊ THÔNG TIN-->
      <script>
        let yearInput, monthInput;
        const confirmbutton = document.getElementById("confirm");

        confirmbutton.addEventListener("click", function (e) {
          e.preventDefault();
          monthInput = document.getElementById("month").value;
          yearInput = document.getElementById("year").value;
          // 2. Kiểm tra xem người dùng đã chọn chưa
          if (!monthInput || !yearInput) {
            alert("Vui lòng chọn đầy đủ Tháng và Năm!");
            return;
          }

          mainTableBody.innerHTML = "";
          loaddata(monthInput, yearInput);
          loadsummary(monthInput, yearInput);
          loadChartData(monthInput, yearInput);
        });
      </script>

      <!--chèn sidebar-->
      <script>
        // Hàm mở/đóng Sidebar
        function openSidebar() {
          const content = document.getElementById("container");
          const backdrop = document.getElementById("sidebar_backdrop");
          if (content && backdrop) {
            content.classList.add("open");
            backdrop.style.display = "block";
            document.body.style.overflow = "hidden";
          }
        }

        function closeSidebar() {
          const content = document.getElementById("container");
          const backdrop = document.getElementById("sidebar_backdrop");
          if (content && backdrop) {
            content.classList.remove("open");
            backdrop.style.display = "none";
            document.body.style.overflow = "";
          }
        }
        //chèn sidebar
        const placeid = "place-sidebar"; //vị trí chèn sidebar
        fetch("../sidebar.html")
          .then((res) => res.text())
          .then((data) => {
            document.getElementById(placeid).innerHTML = data;

            const button_sidebar = document.getElementById("menu_button");
            const backdrop = document.getElementById("sidebar_backdrop");
            const close = document.querySelector(".sidebar-close");

            if (close) {
              close.addEventListener("click", closeSidebar);
            }

            if (button_sidebar) {
              button_sidebar.addEventListener("click", function (e) {
                e.preventDefault();
                openSidebar();
              });
            }
          })
          .catch((err) => console.error("Lỗi khi tải Sidebar:", err));
      </script>
    </div>
  </body>
</html>
