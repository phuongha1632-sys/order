<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Doanh Thu</title>
    <link
      href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div id="s1">
      <div id="header">
        <h1>Doanh thu</h1>
        <div id="place-sidebar"><!--vtri nut sidebar --></div>
      </div>

      <div id="frame1">
        <div id="chart">
          <canvas id="revenueChart"></canvas>
        </div>
        <div id="summary"></div>
      </div>

      <div id="frame2">
        <div id="frame_filter">
          <div class="filter-group">
            <label>Tháng</label>
            <select id="month">
              <option value="" disabled selected hidden>
                -- Chọn tháng --
              </option>
              <option value="1">Tháng 1</option>
              <option value="2">Tháng 2</option>
              <option value="3">Tháng 3</option>
              <option value="4">Tháng 4</option>
              <option value="5">Tháng 5</option>
              <option value="6">Tháng 6</option>
              <option value="7">Tháng 7</option>
              <option value="8">Tháng 8</option>
              <option value="9">Tháng 9</option>
              <option value="10">Tháng 10</option>
              <option value="11">Tháng 11</option>
              <option value="12">Tháng 12</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Năm</label>
            <select id="year">
              <option value="" disabled selected hidden>-- Chọn năm --</option>
              <option value="2023">Năm 2023</option>
              <option value="2024">Năm 2024</option>
              <option value="2025">Năm 2025</option>
              <option value="2026">Năm 2026</option>
              <option value="2027">Năm 2027</option>
              <option value="2028">Năm 2028</option>
            </select>
          </div>
          <div class="filter-group">
            <button id="confirm">Xác nhận</button>
          </div>
        </div>
        <table id="table">
          <thead>
            <tr>
              <th>ID ĐƠN HÀNG</th>
              <th>ID BÀN</th>
              <th>NGÀY</th>
              <th>TỔNG TIỀN</th>
            </tr>
          </thead>
          <tbody id="table_body"></tbody>
        </table>
      </div>

      <!--Chen tt vao bang chi tiet-->
      <script>
        const mainTableBody = document.getElementById("table_body");
        function loaddata(month, year) {
          fetch(
            `http://localhost:5000/doanhthuthang?month=${month}&year=${year}`
          )
            .then((res) => res.json())
            .then((data) => {
              mainTableBody.innerHTML = "";
              if (Array.isArray(data) && data.length > 0) {
                data.forEach((item) => {
                  const row = document.createElement("tr");

                  row.innerHTML = `
                  <td data-id="${item.iddon}">${item.iddon}</td>
                  <td>${item.idban}</td>
                  <td>${item.date}</td>
                  <td data-id="${item.iddon}">${item.total}</td>
                `;

                  mainTableBody.appendChild(row);
                });
              } else {
                // Xử lý trường hợp không có dữ liệu
                mainTableBody.innerHTML =
                  '<tr><td colspan="4">Không tìm thấy đơn hàng nào trong tháng.</td></tr>';
              }
            })
            .catch((err) => {
              console.error("Lỗi khi gửi yêu cầu lấy dữ liệu đơn hàng:", err);
              alert(
                "Lỗi kết nối hoặc xử lý dữ liệu khi hiển thị danh sách đơn hàng."
              );
            });
        }
      </script>

      <!--tải biểu đồ-->
      <script>
        // 1. Khởi tạo biểu đồ trống trước
        const ctx = document.getElementById("revenueChart").getContext("2d");

        let myChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: [], //cột x
            datasets: [
              {
                label: "",
                data: [], // cột y
                borderColor: "#cb3232",
                backgroundColor: "rgba(203, 50, 50, 0.1)",
                tension: 0.3,
                fill: true,
              },
            ],
          },
        });

        // 2. Hàm fetch dữ liệu từ BE
        function loadChartData(month, year) {
          fetch(`http://localhost:5000/summary?month=${month}&year=${year}`)
            .then((res) => res.json())
            .then((data) => {
              const dsachngay = data.map((item) => item.day);
              const danh_sach_tien = data.map((item) => item.tien);
              myChart.data.datasets[0].data = danh_sach_tien;
              myChart.data.datasets[0].label = `Doanh thu tháng ${month} năm ${year}`;
              myChart.data.labels = dsachngay;
              // Vẽ lại biểu đồ với dữ liệu mới
              myChart.update();
            })
            .catch((err) => console.error("Lỗi tải biểu đồ:", err));
        }
      </script>

      <!--Tải tt tổng quát của tháng-->
      <script>
        const right = document.getElementById("summary");
        function loadsummary(month, year) {
          right.innerHTML = "";
          fetch(`http://localhost:5000/summary?month=${month}&year=${year}`)
            .then((res) => res.json())
            .then((data) => {
              right.innerHTML = `
            <p><i class="bx-bxs-fire"></i>Món bán chạy nhất tháng ${data.bestseller}</p>
            <p><i class=" bx-bxs-money">Tổng doanh thu ${data.total}</i></p>`;
            })
            .catch((err) => {
              console.error("Lỗi khi gửi yêu cầu lấy tổng quan:", err);
              alert(
                "Lỗi kết nối hoặc xử lý dữ liệu khi hiển thị tổng quan tháng."
              );
            });
        }
      </script>
      <!--CHỌN TGIAN ĐỂ HIỂN THỊ THÔNG TIN-->
      <script>
        let yearInput, monthInput;
        const confirmbutton = document.getElementById("confirm");
        monthInput = document.getElementById("month").value;
        yearInput = document.getElementById("year").value;

        confirmbutton.addEventListener("click", function (e) {
          // 2. Kiểm tra xem người dùng đã chọn chưa
          if (!monthInput || !yearInput) {
            alert("Vui lòng chọn đầy đủ Tháng và Năm!");
            return;
          }

          e.preventDefault();
          mainTableBody.innerHTML = "";
          loaddata(monthInput, yearInput);
          loadsummary(monthInput, yearInput);
          loadChartData(monthInput, yearInput);
        });
      </script>

      <!--chèn sidebar-->
      <script>
        // Hàm mở/đóng Sidebar
        function openSidebar() {
          const content = document.getElementById("container");
          const backdrop = document.getElementById("sidebar_backdrop");
          if (content && backdrop) {
            content.classList.add("open");
            backdrop.style.display = "block";
            document.body.style.overflow = "hidden";
          }
        }

        function closeSidebar() {
          const content = document.getElementById("container");
          const backdrop = document.getElementById("sidebar_backdrop");
          if (content && backdrop) {
            content.classList.remove("open");
            backdrop.style.display = "none";
            document.body.style.overflow = "";
          }
        }
        //chèn sidebar
        const placeid = "place-sidebar"; //vị trí chèn sidebar
        fetch("../sidebar.html")
          .then((res) => res.text())
          .then((data) => {
            document.getElementById(placeid).innerHTML = data;

            const button_sidebar = document.getElementById("menu_button");
            const backdrop = document.getElementById("sidebar_backdrop");
            const close = document.querySelector(".sidebar-close");

            if (close) {
              close.addEventListener("click", closeSidebar);
            }

            if (button_sidebar) {
              button_sidebar.addEventListener("click", function (e) {
                e.preventDefault();
                openSidebar();
              });
            }
          })
          .catch((err) => console.error("Lỗi khi tải Sidebar:", err));
      </script>
    </div>
  </body>
</html>
