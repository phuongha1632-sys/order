<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Xác Nhận Đơn Hàng</title>
    <link
      href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div id="s1">
      <div id="header">
        <div id="place-sidebar"></div>
        <h1>XÁC NHẬN ĐƠN</h1>
      </div>
      <div id="content">
        <table id="table">
          <thead>
            <tr>
              <th>ID ĐƠN HÀNG</th>
              <th>SỐ BÀN</th>
              <th>NGÀY</th>
              <th>TỔNG TIỀN</th>
              <th>XEM THÔNG TIN</th>
              <th>HÌNH THỨC THANH TOÁN</th>
              <th>XÁC NHẬN</th>
            </tr>
          </thead>
          <tbody id="table_body"></tbody>
        </table>
      </div>

      <!--Các hàm dùng chung-->
      <script>
        // Hàm mở/đóng Modal (Dùng chung cho Order Detail)
        function openModal() {
          modalElement.classList.add("open");
          document.body.style.overflow = "hidden";
          pageElements.forEach((child) => child.classList.add("page-disabled"));
        }

        function hideModal() {
          modalElement.classList.remove("open");
          document.body.style.overflow = "";
          pageElements.forEach((child) =>
            child.classList.remove("page-disabled")
          );
        }
      </script>

      <script>
        // ---------------------- CÁC HÀM XỬ LÝ ĐƠN HÀNG ----------------------//

        //các biến toàn cục
        const mainTableBody = document.getElementById("table_body"); //thân bảng nơi chứa tt tất cả các đơn
        let modalElement;
        let closeButton, modalTitle;
        let pageElements = [];

        // Hàm 1: Tải và Hiển thị TẤT CẢ ĐƠN HÀNG (loadOrders)
        async function loadOrders() {
          try {
            const res = await fetch(
              "http://localhost:3000/api/admin/order/pending"
            );
            const resJson = await res.json(); //chuyển sang Object JS để fe tương tác
            const orders = resJson.data;

            mainTableBody.innerHTML = ""; //làm sạch bảng trc khi cập nhật đơn mới
            if (!orders || orders.length === 0) {
              mainTableBody.innerHTML =
                '<tr><td colspan="7" style="text-align:center;">Không có đơn hàng nào cần xử lý</td></tr>';
              return;
            }

            orders.forEach((item) => {
              const paymentStatusText = item.payment_status === "paid" ? "Thanh toán QR" : "Tiền mặt";
              const paymentClass =
                item.payment_status === "paid"
                  ? "status-paid"
                  : "status-unpaid";

              const row = document.createElement("tr");
              row.innerHTML = `
                <td>${item.id}</td>
                <td>${item.table_number}</td>
                <td>${new Date(item.order_date).toLocaleDateString(
                  "vi-VN"
                )}</td>          
                <td>${item.total_price || "0"}</td>
                <td><a href="#" class="chitietbutton" data-id="${
                  item.id
                }">chi tiết đơn</a></td>
                <td><span class="${paymentClass}">${paymentStatusText}</span></td>
                <td><button class="confirm" data-id="${
                  item.id
                }">Xác nhận</button>
                  <button class="cancel" data-id="${
                    item.id
                  }">Hủy đơn</button></td>`;
              mainTableBody.appendChild(row);
            });
          } catch (err) {
            console.error("Lỗi khi gửi yêu cầu lấy dữ liệu đơn hàng:", err);
            alert(
              "Lỗi kết nối hoặc xử lý dữ liệu khi hiển thị danh sách đơn hàng."
            );
          }
        }
        loadOrders(); //hiển thị thông tin lên bảng chính

       // Hàm 2: Tải và Hiển thị CHI TIẾT ĐƠN HÀNG (loadOrderDetail)
        async function loadOrderDetail(orderId) {
          const modalTableBody = modalElement.querySelector("#chitiet");
          try {
            const res = await fetch(
              `http://localhost:3000/api/admin/order/${orderId}/items`
            );
            const data = await res.json();
            const items = data.items;

            modalTableBody.innerHTML = "";
            if (Array.isArray(items) && items.length > 0) {
              items.forEach((item, index) => {
                const row = document.createElement("tr");
                //theo cấu trúc bảng chi tiết (STT, Tên món, Số lượng, Giá)
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.name}</td>
                    <td>${item.quantity || 1}</td>
                    <td>${new Intl.NumberFormat("vi-VN").format(
                      item.price
                    )} đ</td>                `;

                modalTableBody.appendChild(row);
              });
            } else {
              modalTableBody.innerHTML = `<tr><td colspan="4">Không tìm thấy chi tiết món ăn cho đơn hàng #${orderId}.</td></tr>`;
            }
          } catch (err) {
            console.error("Lỗi khi tải chi tiết đơn:", err);
            alert(`Không thể tải chi tiết món ăn cho đơn hàng #${orderId}.`);
          }
        }
        
        // Hàm 3: Xử lý Xác nhận/Hủy đơn hàng (updateOrderStatus)
        function updateOrderStatus(row, orderId, status) {
          // status nhận vào là "confirm" hoặc "cancel"
          const actionLabel = status === "confirm" ? "xác nhận" : "hủy";

          if (
            !confirm(
              `Bạn có chắc chắn muốn ${actionLabel} đơn hàng số #${orderId} không?`
            )
          ) {
            return;
          }

          fetch(`http://localhost:3000/api/admin/order/${orderId}/${status}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({}), //stringtify{}, nhưng đã gửi status và id ở api
          })
            .then((res) => res.json())
            .then((data) => {
              if (data.status === "success") {
                alert(`${actionLabel} đơn hàng #${orderId} thành công!`);
                row.remove(); // Xóa dòng khỏi bảng "Chờ xử lý"
              } else {
                alert("Thông báo: " + data.message);
              }
            })
            .catch((err) => {
              console.error("Lỗi:", err);
              alert("Lỗi kết nối server!");
            });
        }

        // ---------------------- KHỐI KHỞI TẠO (SETUP) ----------------------

        //Thiết lập Modal (chứa Order Detail)
        fetch("chitietdon.html")
          .then((res) => res.text())
          .then((html) => {
            // 1. CHÈN MODAL VÀO DOM
            const tmp = document.createElement("div");
            tmp.innerHTML = html;
            modalElement = tmp.querySelector("#modal");
            modalElement.classList.add("overlay");
            document.body.appendChild(modalElement);

            // 2. GÁN SỰ KIỆN VÀ THAM CHIẾU
            closeButton = modalElement.querySelector(".close_button");            
            closeButton.addEventListener("click", hideModal);
            // Lấy các phần tử trên trang chính để vô hiệu hóa khi modal mở
            pageElements = Array.from(document.body.children).filter(
              (child) => child !== modalElement && child.tagName !== "SCRIPT"
            );
            // 3. Gán sự kiện click cho bảng
            mainTableBody.addEventListener("click", function (e) {
              const target = e.target;

              if (target.classList.contains("chitietbutton")) {
                e.preventDefault();
                const orderId = target.dataset.id;
                loadOrderDetail(orderId);
                openModal();
              }

              if (target.classList.contains("confirm")) {
                const row = target.closest("tr");
                const orderId = target.dataset.id;
                updateOrderStatus(row, orderId, "confirm");
              }

              if (target.classList.contains("cancel")) {
                const row = target.closest("tr");
                const orderId = target.dataset.id;
                updateOrderStatus(row, orderId, "cancel");
              }
            });
          })
          .catch((err) => console.error("Lỗi khi tải Modal:", err));
      </script>

      <!--sidebar-->
      <script>
        // Hàm mở/đóng Sidebar
        function openSidebar() {
          const content = document.getElementById("container");
          const backdrop = document.getElementById("sidebar_backdrop");
          if (content && backdrop) {
            content.classList.add("open");
            backdrop.style.display = "block";
            document.body.style.overflow = "hidden";
          }
        }

        function closeSidebar() {
          const content = document.getElementById("container");
          const backdrop = document.getElementById("sidebar_backdrop");
          if (content && backdrop) {
            content.classList.remove("open");
            backdrop.style.display = "none";
            document.body.style.overflow = "";
          }
        }
        //chèn sidebar
        const placeid = "place-sidebar"; //vị trí chèn sidebar
        fetch("../sidebar.html")
          .then((res) => res.text())
          .then((data) => {
            document.getElementById(placeid).innerHTML = data;

            const button_sidebar = document.getElementById("menu_button");
            const backdrop = document.getElementById("sidebar_backdrop");
            const close = document.querySelector(".sidebar-close");

            if (close) {
              close.addEventListener("click", closeSidebar);
            }

            if (button_sidebar) {
              button_sidebar.addEventListener("click", function (e) {
                e.preventDefault();
                openSidebar();
              });
            }
          })
          .catch((err) => console.error("Lỗi khi tải Sidebar:", err));
      </script>
    </div>
  </body>
</html>
